{% extends "base.html" %}

{% block title %}DINOv3 Object Detection - MV+{% endblock %}

{% block content %}
<style>
    html, body {
        height: 100%;
        overflow: auto;
        margin: 0;
        padding: 0;
    }

    .dinov3-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        box-sizing: border-box;
    }

    .dinov3-container .main-content {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        grid-auto-rows: minmax(600px, 1fr) !important;
        gap: 30px !important;
        margin-bottom: 30px !important;
        margin-top: 0 !important;
        padding: 0 !important;
        overflow-y: visible !important;
        flex: 1;
        min-height: 0;
    }

    .card {
        background: rgba(0, 0, 0, 0.8);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        border: none;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        min-height: 600px;
        height: 100%;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        border-color: #B91D30;
    }

    .card h2 {
        color: #ffffff;
        margin-bottom: 12px;
        font-size: 1.6rem;
        font-weight: normal;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .upload-section {
        margin-bottom: 25px;
    }

    .upload-options {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .upload-btn {
        flex: 1;
        padding: 15px;
        border: 2px dashed #555555;
        border-radius: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 0, 0, 0.3);
        color: #ffffff;
        font-size: 1rem;
    }

    .upload-btn:hover {
        background: rgba(185, 29, 48, 0.1);
        color: white;
        border-color: #555555;
    }

    .upload-btn.active {
        background: rgba(0, 0, 0, 0.3);
        border-color: #555555;
    }

    .upload-btn i {
        margin-right: 8px;
        font-size: 1rem;
    }

    .file-input {
        display: none;
    }

    /* File Browser Modal */
    .file-browser-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .file-browser-modal.active {
        display: flex;
    }

    .file-browser-content {
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #B91D30;
        border-radius: 20px;
        padding: 30px;
        max-width: 800px;
        max-height: 80vh;
        width: 90%;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .file-browser-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
    }

    .file-browser-header h3 {
        color: #ffffff;
        margin: 0;
        font-size: 1.5rem;
    }

    .file-browser-close {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 5px;
        transition: background 0.3s ease;
    }

    .file-browser-close:hover {
        background: rgba(185, 29, 48, 0.3);
    }

    .file-browser-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .file-browser-item {
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid #333;
        border-radius: 8px;
        padding: 12px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        text-align: left;
    }

    .file-browser-item:hover {
        border-color: #B91D30;
        background: rgba(185, 29, 48, 0.1);
        transform: translateX(5px);
    }

    .file-browser-item.selected {
        border-color: #B91D30;
        background: rgba(185, 29, 48, 0.2);
    }

    .file-browser-item img {
        display: none;
    }

    .file-browser-item .file-name {
        color: #ffffff;
        font-size: 0.9rem;
        word-break: break-word;
        flex: 1;
        margin-right: 15px;
    }

    .file-browser-item .file-size {
        color: #999;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .file-browser-item.directory {
        border-color: #555;
    }

    .file-browser-item.directory:hover {
        border-color: #B91D30;
    }

    .file-browser-item.directory .file-name {
        color: #B91D30;
        font-weight: bold;
    }

    .file-browser-item.directory .directory-icon {
        font-size: 2rem;
        color: #B91D30;
        margin-bottom: 10px;
    }

    .file-browser-breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        flex-wrap: wrap;
    }

    .file-browser-breadcrumb-item {
        color: #ffffff;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background 0.3s ease;
    }

    .file-browser-breadcrumb-item:hover {
        background: rgba(185, 29, 48, 0.3);
    }

    .file-browser-breadcrumb-item.active {
        color: #B91D30;
        cursor: default;
    }

    .file-browser-breadcrumb-separator {
        color: #666;
    }

    .file-browser-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #333;
    }

    .file-browser-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .file-browser-btn-primary {
        background: #B91D30;
        color: white;
    }

    .file-browser-btn-primary:hover {
        background: #8a1523;
    }

    .file-browser-btn-secondary {
        background: #333;
        color: white;
    }

    .file-browser-btn-secondary:hover {
        background: #555;
    }

    .file-browser-loading {
        text-align: center;
        color: #ffffff;
        padding: 40px;
    }

    .file-browser-empty {
        text-align: center;
        color: #999;
        padding: 40px;
    }

    .image-controls {
        margin-bottom: 25px;
        display: none !important;
    }

    .control-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .control-item {
        display: flex;
        flex-direction: column;
    }

    .control-item label {
        margin-bottom: 5px;
        font-weight: normal;
        color: #ffffff;
        font-size: 0.9rem;
    }

    .control-item input {
        padding: 12px;
        border: 2px solid #333333;
        border-radius: 8px;
        font-size: 0.9rem;
        background: rgba(0, 0, 0, 0.6);
        color: #ffffff;
        transition: border-color 0.3s ease;
    }

    .control-item input:focus {
        outline: none;
        border-color: #B91D30;
    }

    /* Detection Results Container - Match Architecture Details Width */
    #detectionResultsContainer {
        width: 100%;
        max-width: none;
        margin-bottom: 15px;
        border: none;
        border-radius: 10px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.6);
        box-sizing: border-box;
    }

    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .preview-header h4 {
        color: #ffffff;
        margin: 0;
        font-size: 1rem;
        font-weight: normal;
    }

    .reset-crop-btn {
        padding: 6px 12px;
        background: #B91D30;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.3s ease;
    }

    .reset-crop-btn:hover {
        background: #CC0000;
    }

    .image-preview-wrapper {
        position: relative;
        display: inline-block;
        border: none;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
        max-width: 100%;
        max-height: 300px;
    }

    .image-preview-canvas {
        max-width: 100%;
        max-height: 300px;
        cursor: crosshair;
        display: block;
        image-rendering: auto;
        image-rendering: smooth;
    }

    #resultImage {
        width: 100%;
        height: 100%;
        max-height: 300px;
        border-radius: 8px;
        object-fit: contain;
        display: block;
        margin: 0 auto;
    }

    .crop-overlay {
        position: absolute;
        border: 2px dashed #B91D30;
        background: rgba(185, 29, 48, 0.1);
        pointer-events: none;
        display: none;
    }

    .crop-instructions {
        margin-top: 10px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        font-size: 0.8rem;
        color: #cccccc;
        text-align: center;
    }

    .crop-instructions i {
        margin-right: 5px;
        color: #B91D30;
    }


    .transform-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .transform-btn-small {
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #333333;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        color: #ffffff;
        min-width: 40px;
        min-height: 40px;
    }

    .transform-btn-small .btn-text {
        color: #ffffff !important;
        font-size: 1.2rem !important;
        display: inline-block !important;
        font-weight: bold !important;
        text-align: center !important;
        vertical-align: middle !important;
    }


    .transform-btn-small {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .transform-btn-small:hover {
        background: rgba(185, 29, 48, 0.3);
        border-color: #ffffff;
    }

    .transform-btn-small:hover i {
        color: #ffffff !important;
        transform: scale(1.1);
    }

    .transform-btn-small:active {
        transform: translateY(1px);
    }

    /* Compact Controls Styling */
    .compact-controls {
        margin-top: 15px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 15px;
        border: 2px solid #333333;
    }

    .control-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .control-group-compact {
        display: flex;
        flex-direction: column;
        min-width: 60px;
    }

    .control-group-compact label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 3px;
    }

    .control-group-compact input {
        padding: 6px 8px;
        border: 1px solid #333333;
        border-radius: 6px;
        font-size: 0.8rem;
        width: 60px;
        background: rgba(0, 0, 0, 0.6);
        color: #ffffff;
        transition: border-color 0.3s ease;
    }

    .control-group-compact input:focus {
        outline: none;
        border-color: #B91D30;
    }

    .transform-buttons-compact {
        display: flex !important;
        gap: 8px;
        margin-bottom: 10px;
        justify-content: center;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .status-display {
        display: flex;
        gap: 15px;
        justify-content: center;
        font-size: 0.8rem;
        color: #cccccc;
    }

    .detect-btn {
        width: 100%;
        padding: 16px;
        background: #555555;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        transition: all 0.3s ease;
        margin-top: 15px;
        opacity: 0.9;
    }

    .detect-btn:hover {
        background: #666666;
        transform: translateY(-2px);
        opacity: 0.95;
    }

    .detect-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: rgba(0, 0, 0, 0.3);
        color: #888888;
    }

    .performance-stats {
        display: grid;
        grid-template-columns: 1fr;
        gap: 4px;
        margin-bottom: 8px;
    }

    .stat-card {
        background: rgba(0, 0, 0, 0.6);
        padding: 6px 8px;
        border-radius: 10px;
        text-align: left;
        border: none;
    }

    .stat-value {
        font-size: 0.8rem;
        font-weight: normal;
        color: #ffffff; /* match stat-label color */
        margin: 0;
        line-height: 1.1;
    }

    .stat-label {
        color: #cccccc;
        font-size: 0.8rem;
        font-weight: normal;
        margin: 0 0 2px 0;
        line-height: 1.1;
    }

    .architecture-details {
        background: rgba(0, 0, 0, 0.6);
        padding: 25px;
        border-radius: 20px;
        border: none;
    }

    .architecture-details h3 {
        color: #ffffff;
        margin-bottom: 15px;
        font-size: 1.3rem;
        font-weight: normal;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .detail-item {
        text-align: left;
    }

    .detail-label {
        color: #ffffff;
        font-size: 0.85rem;
        margin-bottom: 2px;
        font-weight: normal;
    }

    .detail-value {
        color: #ffffff;
        font-weight: normal;
        font-size: 0.95rem;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #B91D30;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message, .success-message {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
    }

    .error-message {
        background: rgba(220, 53, 69, 0.2);
        border: 2px solid #dc3545;
        color: #dc3545;
    }

    .success-message {
        background: rgba(40, 167, 69, 0.2);
        border: 2px solid #28a745;
        color: #28a745;
    }

    .batch-navigation {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
    }

    .batch-info {
        flex: 1;
        color: #ffffff;
        font-size: 0.9rem;
    }

    .batch-counter {
        font-weight: bold;
        color: #B91D30;
    }

    .batch-btn {
        padding: 6px 12px;
        background: rgba(185, 29, 48, 0.2);
        color: #ffffff;
        border: 1px solid #B91D30;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }

    .batch-btn:hover {
        background: rgba(185, 29, 48, 0.3);
    }

    .batch-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .control-group {
            grid-template-columns: 1fr;
        }
        
        .performance-stats {
            grid-template-columns: 1fr;
        }
        
        .upload-options {
            flex-direction: column;
        }
        
        .control-row {
            justify-content: center;
        }
        
        .control-group-compact {
            min-width: 50px;
        }
        
        .control-group-compact input {
            width: 50px;
        }
        
        .transform-buttons-compact {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .status-display {
            flex-direction: column;
            gap: 5px;
        }
    }
</style>

<div class="dinov3-container">
    <div id="errorMessage" class="error-message" style="display: none;"></div>
    <div id="successMessage" class="success-message" style="display: none;"></div>

    <div class="main-content">
        <div class="card">
            <h2>Image Upload & Processing</h2>
            
            <div class="upload-section">
                <div class="upload-options">
                    <div class="upload-btn active" id="singleUploadBtn">
                        Single Image
                    </div>
                    <div class="upload-btn" id="batchUploadBtn">
                        Batch Upload
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.JPG,.PNG,.HEIC,.heic,image/jpeg,image/png,image/heic" multiple>
                <input type="file" id="batchFileInput" class="file-input" accept=".jpg,.jpeg,.png,.JPG,.PNG,.HEIC,.heic,image/jpeg,image/png,image/heic" multiple>
                
                <!-- Loading Indicator -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>
            </div>
                
            <!-- Image Preview and Crop Area -->
            <div class="image-preview-container" id="imagePreviewContainer" style="display: none;">
                <div class="preview-header">
                    <h4>Image Preview & Crop</h4>
                </div>
                <div class="image-preview-wrapper">
                    <canvas id="imagePreview" class="image-preview-canvas"></canvas>
                    <div class="crop-overlay" id="cropOverlay"></div>
                </div>
                <div class="crop-instructions">
                    <i class="fas fa-info-circle"></i>
                    Drag to select crop area. Detection will analyze the selected region.
                </div>

                <!-- Batch Navigation Controls (hidden until batch upload) -->
                <div class="batch-navigation" id="batchNavigation" style="display: none;">
                    <div class="batch-info">
                        <span class="batch-counter" id="batchCounter">1 of 1</span>
                    </div>
                    <button class="batch-btn" id="prevImageBtn" disabled>Previous</button>
                    <button class="batch-btn" id="nextImageBtn" disabled>Next</button>
                </div>

                <!-- Compact Controls Row -->
                <div class="compact-controls">
                    <div class="transform-buttons-compact">
                        <button type="button" class="transform-btn-small" onclick="rotateImage(90)" title="Rotate 90¬∞">
                            <span class="btn-text">‚Üª</span>
                        </button>
                        <button type="button" class="transform-btn-small" onclick="rotateImage(-90)" title="Rotate -90¬∞">
                            <span class="btn-text">‚Ü∫</span>
                        </button>
                        <button type="button" class="transform-btn-small" onclick="flipImage('horizontal')" title="Flip Horizontal">
                            <span class="btn-text">‚Üî</span>
                        </button>
                        <button type="button" class="transform-btn-small" onclick="flipImage('vertical')" title="Flip Vertical">
                            <span class="btn-text">‚Üï</span>
                        </button>
                        <button type="button" class="transform-btn-small reset-btn" onclick="resetCrop()" title="Reset Crop">
                            <span class="btn-text">‚úï</span>
                        </button>
                    </div>
                    
                    <div class="status-display">
                        <span>Rotation: <span id="rotationAngle">0¬∞</span></span>
                        <span>Flip: <span id="flipStatus">None</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Model Selection -->
            <div class="control-group">
                <div class="control-item">
                    <label>Select Model Weight:</label>
                    <select id="modelSelect" disabled>
                        <option value="">Loading weights...</option>
                    </select>
                </div>
            </div>

            <!-- Detect Button -->
            <button type="button" class="detect-btn" id="detectBtn" disabled>
                <i class="fas fa-search"></i> Detect Objects
            </button>
        </div>

        <div class="card">
            <h2>Performance & Architecture</h2>
            
            <div class="performance-stats">
                <div class="stat-card">
                    <div class="stat-label">Inference Time</div>
                    <div class="stat-value" id="inferenceTime">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Parameters</div>
                    <div class="stat-value" id="modelSize">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Input Size</div>
                    <div class="stat-value" id="inputSize">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Batch Size</div>
                    <div class="stat-value" id="batchSize">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Used Weight</div>
                    <div class="stat-value" id="usedWeightPath">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inferred #Classes</div>
                    <div class="stat-value" id="inferredNumClasses">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Classes</div>
                    <div class="stat-value" id="classNames">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Model Type</div>
                    <div class="stat-value" id="architecture">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Backbone</div>
                    <div class="stat-value" id="backbone">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Attention Heads</div>
                    <div class="stat-value" id="attentionHeads">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Layers</div>
                    <div class="stat-value" id="layers">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Embedding Dim</div>
                    <div class="stat-value" id="embeddingDim">--</div>
                </div>
            </div>

            <div class="architecture-details">

                <!-- Detection Results (compact style) -->
                <div class="image-preview-container" id="detectionResultsContainer" style="display: none;">
                    <div class="preview-header">
                        <h4><i class="fas fa-search"></i> Detection Results</h4>
                    </div>
                    <div class="image-preview-wrapper">
                        <img id="resultImage" class="image-preview-canvas" alt="Detection Result">
                    </div>
                    <div class="prediction-result" id="predictionResult" style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                        <div class="prediction-class" id="predictionClass" style="font-size: 1.1rem; font-weight: bold; color: #9ae6b4; margin-bottom: 6px;"></div>
                        <div class="prediction-confidence" id="predictionConfidence" style="font-size: 0.9rem; color: #ffffff; margin-bottom: 8px;"></div>
                        <div class="top3-predictions" id="top3Predictions" style="font-size: 0.8rem; color: #ffffff;">
                            <div class="prediction-entry" id="prediction1">1. -</div>
                            <div class="prediction-entry" id="prediction2">2. -</div>
                            <div class="prediction-entry" id="prediction3">3. -</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="file-browser-modal" id="fileBrowserModal">
        <div class="file-browser-content">
            <div class="file-browser-header">
                <h3>Select Test Image</h3>
                <button class="file-browser-close" id="fileBrowserClose">&times;</button>
            </div>
            <div id="fileBrowserBreadcrumb" class="file-browser-breadcrumb"></div>
            <div id="fileBrowserList" class="file-browser-list">
                <div class="file-browser-loading">Loading images...</div>
            </div>
            <div class="file-browser-actions">
                <button class="file-browser-btn file-browser-btn-secondary" id="fileBrowserCancel">Cancel</button>
                <button class="file-browser-btn file-browser-btn-primary" id="fileBrowserSelect" disabled>Select</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
// Initialize variables
let currentUploadMode = 'single';
    let selectedFile = null;
    let currentImage = null;
    let currentRotation = 0;
    let currentFlip = {
        horizontal: false,
        vertical: false
    };
    let batchFiles = [];
    let currentBatchIndex = 0;
    let isDragging = false;
    let isCropping = false;
    let cropRect = { x: 0, y: 0, w: 0, h: 0 };

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        setupBatchNavigation();
    });

    function setupEventListeners() {
        const singleUploadBtn = document.getElementById('singleUploadBtn');
        const batchUploadBtn = document.getElementById('batchUploadBtn');
        const fileInput = document.getElementById('fileInput');
        const batchFileInput = document.getElementById('batchFileInput');
        const canvas = document.getElementById('imagePreview');
        const overlay = document.getElementById('cropOverlay');

        // File Browser Modal
        const fileBrowserModal = document.getElementById('fileBrowserModal');
        const fileBrowserClose = document.getElementById('fileBrowserClose');
        const fileBrowserCancel = document.getElementById('fileBrowserCancel');
        const fileBrowserSelect = document.getElementById('fileBrowserSelect');
        const fileBrowserList = document.getElementById('fileBrowserList');
        const fileBrowserBreadcrumb = document.getElementById('fileBrowserBreadcrumb');
        let selectedFiles = [];
        let isBatchMode = false;
        let currentPath = ''; // Track current directory path

        // File browser functions
        async function openFileBrowser() {
            fileBrowserModal.classList.add('active');
            fileBrowserList.innerHTML = '<div class="file-browser-loading">Loading images...</div>';
            fileBrowserSelect.disabled = true;
            selectedFiles = [];
            currentPath = ''; // Reset to root directory
            await loadDirectory('');
        }

        async function loadDirectory(subpath) {
            fileBrowserList.innerHTML = '<div class="file-browser-loading">Loading...</div>';
            fileBrowserSelect.disabled = true;
            selectedFiles = [];
            currentPath = subpath;
            
            try {
                let url = '/api/list_testimages/dinov3_demo';
                if (subpath) {
                    url += '/' + encodeURIComponent(subpath);
                }
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && (data.directories && data.directories.length > 0 || data.files && data.files.length > 0)) {
                    // Update breadcrumb
                    updateBreadcrumb(data.relative_path || '');
                    
                    fileBrowserList.innerHTML = '';
                    
                    // Display directories first
                    if (data.directories && data.directories.length > 0) {
                        data.directories.forEach(dir => {
                            const dirItem = document.createElement('div');
                            dirItem.className = 'file-browser-item directory';
                            dirItem.dataset.filename = dir.name;
                            dirItem.dataset.type = 'directory';
                            
                            dirItem.innerHTML = `
                                <div class="file-name">üìÅ ${dir.name}</div>
                                <div class="file-size">Directory</div>
                            `;
                            
                            // Click to navigate into directory
                            dirItem.addEventListener('click', () => {
                                const newPath = currentPath ? `${currentPath}/${dir.name}` : dir.name;
                                loadDirectory(newPath);
                            });
                            
                            fileBrowserList.appendChild(dirItem);
                        });
                    }
                    
                    // Display files
                    if (data.files && data.files.length > 0) {
                        data.files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-browser-item';
                            fileItem.dataset.filename = file.name;
                            fileItem.dataset.type = 'file';
                            
                            const filePath = currentPath ? `${currentPath}/${file.name}` : file.name;
                            const fileSize = formatFileSize(file.size);
                            
                            fileItem.innerHTML = `
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${fileSize}</div>
                            `;
                            
                            // Single click - select in batch mode, import directly in single mode
                            fileItem.addEventListener('click', () => {
                                if (isBatchMode) {
                                    if (fileItem.classList.contains('selected')) {
                                        fileItem.classList.remove('selected');
                                        selectedFiles = selectedFiles.filter(f => f.path !== filePath);
                                    } else {
                                        fileItem.classList.add('selected');
                                        selectedFiles.push({ name: file.name, path: filePath });
                                    }
                                    fileBrowserSelect.disabled = selectedFiles.length === 0;
                                } else {
                                    document.querySelectorAll('.file-browser-item').forEach(item => {
                                        item.classList.remove('selected');
                                    });
                                    fileItem.classList.add('selected');
                                    selectedFiles = [{ name: file.name, path: filePath }];
                                    fileBrowserSelect.disabled = false;
                                    loadFilesFromBrowser([{ name: file.name, path: filePath }]);
                                    closeFileBrowser();
                                }
                            });
                            
                            // Double click - always import directly
                            fileItem.addEventListener('dblclick', () => {
                                loadFilesFromBrowser([{ name: file.name, path: filePath }]);
                                closeFileBrowser();
                            });
                            
                            fileBrowserList.appendChild(fileItem);
                        });
                    }
                } else {
                    updateBreadcrumb(data.relative_path || '');
                    fileBrowserList.innerHTML = '<div class="file-browser-empty">No files or directories found</div>';
                }
            } catch (error) {
                console.error('Error loading directory:', error);
                fileBrowserList.innerHTML = '<div class="file-browser-empty">Error loading directory. Please try again.</div>';
            }
        }

        function updateBreadcrumb(relativePath) {
            fileBrowserBreadcrumb.innerHTML = '';
            
            // Add root
            const rootItem = document.createElement('span');
            rootItem.className = 'file-browser-breadcrumb-item' + (relativePath === '' ? ' active' : '');
            rootItem.textContent = 'Root';
            rootItem.addEventListener('click', () => {
                if (relativePath !== '') {
                    loadDirectory('');
                }
            });
            fileBrowserBreadcrumb.appendChild(rootItem);
            
            // Add path segments
            if (relativePath) {
                const segments = relativePath.split('/');
                let currentPath = '';
                
                segments.forEach((segment, index) => {
                    // Separator
                    const separator = document.createElement('span');
                    separator.className = 'file-browser-breadcrumb-separator';
                    separator.textContent = ' / ';
                    fileBrowserBreadcrumb.appendChild(separator);
                    
                    // Path segment
                    currentPath = currentPath ? `${currentPath}/${segment}` : segment;
                    const isLast = index === segments.length - 1;
                    
                    const pathItem = document.createElement('span');
                    pathItem.className = 'file-browser-breadcrumb-item' + (isLast ? ' active' : '');
                    pathItem.textContent = segment;
                    if (!isLast) {
                        pathItem.addEventListener('click', () => {
                            loadDirectory(currentPath);
                        });
                    }
                    fileBrowserBreadcrumb.appendChild(pathItem);
                });
            }
        }

        function closeFileBrowser() {
            fileBrowserModal.classList.remove('active');
            selectedFiles = [];
            currentPath = '';
            fileBrowserSelect.disabled = true;
        }

        // Upload buttons - open file browser modal
        singleUploadBtn.addEventListener('click', () => {
            currentUploadMode = 'single';
            singleUploadBtn.classList.add('active');
            batchUploadBtn.classList.remove('active');
            isBatchMode = false;
            selectedFiles = [];
            openFileBrowser();
        });

        batchUploadBtn.addEventListener('click', () => {
            currentUploadMode = 'batch';
            batchUploadBtn.classList.add('active');
            singleUploadBtn.classList.remove('active');
            isBatchMode = true;
            selectedFiles = [];
            openFileBrowser();
        });

        // Close modal handlers
        fileBrowserClose.addEventListener('click', closeFileBrowser);
        fileBrowserCancel.addEventListener('click', closeFileBrowser);
        fileBrowserModal.addEventListener('click', (e) => {
            if (e.target === fileBrowserModal) {
                closeFileBrowser();
            }
        });

        // Select button handler
        fileBrowserSelect.addEventListener('click', () => {
            if (selectedFiles.length === 0) return;
            
            if (isBatchMode) {
                loadFilesFromBrowser(selectedFiles);
            } else {
                loadFilesFromBrowser([selectedFiles[0]]);
            }
            closeFileBrowser();
        });

        async function loadFilesFromBrowser(fileItems) {
            try {
                // fileItems can be either array of strings (old format) or array of objects with {name, path}
                const normalizedItems = fileItems.map(item => {
                    if (typeof item === 'string') {
                        return { name: item, path: item };
                    }
                    return item;
                });
                
                if (isBatchMode) {
                    const files = [];
                    for (const fileItem of normalizedItems) {
                        const response = await fetch(`/api/get_testimage/dinov3_demo/${encodeURIComponent(fileItem.path)}`);
                        if (!response.ok) {
                            throw new Error(`Failed to load ${fileItem.name}: ${response.statusText}`);
                        }
                        const blob = await response.blob();
                        const ext = fileItem.name.split('.').pop();
                        const mimeTypes = {
                            'jpg': 'image/jpeg', 'JPG': 'image/jpeg',
                            'jpeg': 'image/jpeg', 'JPEG': 'image/jpeg',
                            'png': 'image/png', 'PNG': 'image/png',
                            'gif': 'image/gif', 'GIF': 'image/gif',
                            'webp': 'image/webp', 'WEBP': 'image/webp',
                            'bmp': 'image/bmp', 'BMP': 'image/bmp',
                            'tiff': 'image/tiff', 'TIFF': 'image/tiff',
                            'tif': 'image/tiff', 'TIF': 'image/tiff',
                            'heic': 'image/heic', 'HEIC': 'image/heic',
                            'sto': 'application/octet-stream', 'STO': 'application/octet-stream'
                        };
                        const mimeType = mimeTypes[ext] || mimeTypes[ext.toLowerCase()] || blob.type || 'image/jpeg';
                        const file = new File([blob], fileItem.name, { type: mimeType, lastModified: Date.now() });
                        files.push(file);
                    }
                    const dataTransfer = new DataTransfer();
                    files.forEach(file => dataTransfer.items.add(file));
                    // Clear the input first, then set files
                    batchFileInput.value = '';
                    batchFileInput.files = dataTransfer.files;
                    // Trigger change event to process the files and display preview
                    const changeEvent = new Event('change', { bubbles: true });
                    batchFileInput.dispatchEvent(changeEvent);
                } else {
                    const fileItem = normalizedItems[0];
                    const response = await fetch(`/api/get_testimage/dinov3_demo/${encodeURIComponent(fileItem.path)}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${fileItem.name}: ${response.statusText}`);
                    }
                    const blob = await response.blob();
                    const ext = fileItem.name.split('.').pop().toLowerCase();
                    const mimeTypes = {
                        'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png',
                        'gif': 'image/gif', 'webp': 'image/webp', 'heic': 'image/heic', 'HEIC': 'image/heic'
                    };
                    const mimeType = mimeTypes[ext] || blob.type || 'image/jpeg';
                    const file = new File([blob], fileItem.name, { type: mimeType, lastModified: Date.now() });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    // Clear the input first, then set files
                    fileInput.value = '';
                    fileInput.files = dataTransfer.files;
                    // Trigger change event to process the file and display preview
                    const changeEvent = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(changeEvent);
                }
            } catch (error) {
                console.error('Error loading file from browser:', error);
                alert(`Error loading file: ${error.message}. Please try again.`);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // File input change handlers - these work for both file browser modal and direct file selection
        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                handleFileSelect(e);
            }
        });
        
        batchFileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files.length > 0) {
                handleBatchFileSelect(e);
            }
        });

        // Crop tool events
        canvas.addEventListener('mousedown', (e) => {
            if (!currentImage) return;
            const rect = canvas.getBoundingClientRect();
            isCropping = true;
            cropRect.x = Math.max(0, e.clientX - rect.left);
            cropRect.y = Math.max(0, e.clientY - rect.top);
            cropRect.w = 0;
            cropRect.h = 0;
            overlay.style.display = 'block';
            updateCropOverlayPosition();
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isCropping) return;
            const rect = canvas.getBoundingClientRect();
            const curX = Math.max(0, Math.min(canvas.width, e.clientX - rect.left));
            const curY = Math.max(0, Math.min(canvas.height, e.clientY - rect.top));
            cropRect.w = curX - cropRect.x;
            cropRect.h = curY - cropRect.y;
            updateCropOverlayPosition();
        });

        window.addEventListener('mouseup', () => {
            if (!isCropping) return;
            isCropping = false;
            normalizeCropRect();
            updateCropOverlayPosition();
            document.getElementById('cropOverlay').style.display = isCropActive() ? 'block' : 'none';
        });
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            selectedFile = file;
            displayImagePreview(file);
        }
        // Reset file input to allow uploading the same file again
        e.target.value = '';
    }

    function handleBatchFileSelect(e) {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            batchFiles = files;
            currentBatchIndex = 0;
            selectedFile = files[0];
            displayImagePreview(files[0]);
            showBatchNavigation();
        }
        // Reset file input to allow uploading the same files again
        e.target.value = '';
    }

    function displayImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.getElementById('imagePreview');
                if (!canvas) {
                    console.error('Canvas element not found');
                    return;
                }
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }
                
                const maxWidth = 400;
                const maxHeight = 300;
                const width = img.width;
                const height = img.height;
                
                // Calculate display dimensions
                let displayWidth = width;
                let displayHeight = height;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    displayWidth = width * ratio;
                    displayHeight = height * ratio;
                }
                
                // Set canvas size to display dimensions
                canvas.width = displayWidth;
                canvas.height = displayHeight;
                
                // Enable image smoothing for better quality
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                currentImage = img;
                
                // Show image preview container
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                if (imagePreviewContainer) {
                    imagePreviewContainer.style.display = 'block';
                } else {
                    console.error('Image preview container not found');
                }
                
                enableModelSelection();
                
                // Initialize crop values to full image dimensions but don't show overlay
                // Store crop values in variables since input fields were removed
                window.cropX = 0;
                window.cropY = 0;
                window.cropW = displayWidth;
                window.cropH = displayHeight;
                
                // Hide crop overlay initially - only show when user drags
                const overlay = document.getElementById('cropOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                // Draw image with current transforms
                redrawImageWithTransforms();
                
                const detectionResultsContainer = document.getElementById('detectionResultsContainer');
                detectionResultsContainer.style.display = 'none';
                
                // Check if detect button should be enabled
                const modelSelect = document.getElementById('modelSelect');
                const detectBtn = document.getElementById('detectBtn');
                if (modelSelect.value && selectedFile) {
                    detectBtn.disabled = false;
                    console.log('Detect button enabled - image uploaded and model selected');
                }
                
                console.log('Image loaded:', {
                    original: { width: img.width, height: img.height },
                    display: { width: displayWidth, height: displayHeight },
                    filename: file.name
                });
            };
            img.onerror = function() {
                console.error('Failed to load image:', file.name);
                alert('Failed to load image. Please try again.');
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            console.error('Failed to read file:', file.name);
            alert('Failed to read file. Please try again.');
        };
        reader.readAsDataURL(file);
    }

    function enableModelSelection() {
        const modelSelect = document.getElementById('modelSelect');
        modelSelect.disabled = false;
        loadModelWeights();
        
        // Add event listener for model selection
        modelSelect.addEventListener('change', function() {
            const detectBtn = document.getElementById('detectBtn');
            if (this.value && selectedFile) {
                detectBtn.disabled = false;
                console.log('Detect button enabled - model selected:', this.value);
            } else {
                detectBtn.disabled = true;
                console.log('Detect button disabled - no model or file selected');
            }
        });
    }

    async function loadModelWeights() {
        try {
            const response = await fetch('/api/dinov3_weights');
            const data = await response.json();
            
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '';
            
            if (data.success && data.weights) {
                data.weights.forEach(weight => {
                    const option = document.createElement('option');
                    option.value = weight.path;
                    option.textContent = weight.display_name;
                    modelSelect.appendChild(option);
                });
            } else {
                modelSelect.innerHTML = '<option value="">No weights available</option>';
            }
        } catch (error) {
            console.error('Error loading model weights:', error);
        }
    }


    function resetTransforms() {
        // Reset transforms
        currentRotation = 0;
        currentFlip = { horizontal: false, vertical: false };
        
        // Update status display
        document.getElementById('rotationAngle').textContent = '0¬∞';
        document.getElementById('flipStatus').textContent = 'None';
        
        // Redraw image without transforms
        redrawImageWithTransforms();
        clearCrop();
    }

    function resetCrop() {
        // Reset image to original uploaded state - clears all transforms and crop
        currentRotation = 0;
        currentFlip = { horizontal: false, vertical: false };
        clearCrop();
        
        // Update status display
        document.getElementById('rotationAngle').textContent = '0¬∞';
        document.getElementById('flipStatus').textContent = 'None';
        
        // Redraw image without any transforms
        if (currentImage) {
            redrawImageWithTransforms();
        }
    }

    function rotateImage(degrees) {
        currentRotation = (currentRotation + degrees) % 360;
        if (currentRotation < 0) currentRotation += 360;
        
        document.getElementById('rotationAngle').textContent = currentRotation + '¬∞';
        
        if (currentImage) {
            redrawImageWithTransforms();
        }
    }

    function flipImage(direction) {
        if (direction === 'horizontal') {
            currentFlip.horizontal = !currentFlip.horizontal;
        } else if (direction === 'vertical') {
            currentFlip.vertical = !currentFlip.vertical;
        }
        
        const flipStatus = [];
        if (currentFlip.horizontal) flipStatus.push('H');
        if (currentFlip.vertical) flipStatus.push('V');
        document.getElementById('flipStatus').textContent = flipStatus.length > 0 ? flipStatus.join(', ') : 'None';
        
        if (currentImage) {
            redrawImageWithTransforms();
        }
    }

    function redrawImageWithTransforms() {
        if (!currentImage) {
            console.warn('redrawImageWithTransforms: currentImage is null');
            return;
        }
        
        const canvas = document.getElementById('imagePreview');
        if (!canvas) {
            console.error('redrawImageWithTransforms: Canvas element not found');
            return;
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('redrawImageWithTransforms: Could not get canvas context');
            return;
        }
        
        const maxWidth = 400;
        const maxHeight = 300;
        const width = currentImage.width;
        const height = currentImage.height;
        
        // Calculate display dimensions
        let displayWidth = width;
        let displayHeight = height;
        
        if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            displayWidth = width * ratio;
            displayHeight = height * ratio;
        }
        
        // Set canvas size to display dimensions
        canvas.width = displayWidth;
        canvas.height = displayHeight;
        
        // Enable image smoothing for better quality
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // Clear canvas
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        
        // Save context state
        ctx.save();
        
        // Move to center of canvas
        ctx.translate(displayWidth / 2, displayHeight / 2);
        
        // Apply rotation
        if (currentRotation !== 0) {
            ctx.rotate((currentRotation * Math.PI) / 180);
        }
        
        // Apply flips
        let scaleX = 1;
        let scaleY = 1;
        if (currentFlip.horizontal) scaleX = -1;
        if (currentFlip.vertical) scaleY = -1;
        ctx.scale(scaleX, scaleY);
        
        // Draw image centered
        ctx.drawImage(currentImage, -displayWidth / 2, -displayHeight / 2, displayWidth, displayHeight);
        
        // Restore context state
        ctx.restore();
        
        console.log('Image redrawn with transforms:', {
            rotation: currentRotation,
            flip: currentFlip,
            displaySize: { width: displayWidth, height: displayHeight }
        });

        // Keep overlay aligned with canvas
        updateCropOverlayPosition();
    }


    function setupBatchNavigation() {
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');
        
        prevBtn.addEventListener('click', () => {
            if (currentBatchIndex > 0) {
                currentBatchIndex--;
                selectedFile = batchFiles[currentBatchIndex];
                displayImagePreview(selectedFile);
                updateBatchCounter();
                updateBatchButtons();
            }
        });
        
        nextBtn.addEventListener('click', () => {
            if (currentBatchIndex < batchFiles.length - 1) {
                currentBatchIndex++;
                selectedFile = batchFiles[currentBatchIndex];
                displayImagePreview(selectedFile);
                updateBatchCounter();
                updateBatchButtons();
            }
        });
    }

    function showBatchNavigation() {
        document.getElementById('batchNavigation').style.display = 'flex';
        updateBatchCounter();
        updateBatchButtons();
    }

    function updateBatchCounter() {
        document.getElementById('batchCounter').textContent = `${currentBatchIndex + 1} of ${batchFiles.length}`;
    }

    function updateBatchButtons() {
        const prevBtn = document.getElementById('prevImageBtn');
        const nextBtn = document.getElementById('nextImageBtn');
        
        prevBtn.disabled = currentBatchIndex === 0;
        nextBtn.disabled = currentBatchIndex === batchFiles.length - 1;
    }

    function resetAllStatValues() {
        // Reset all stat-value elements to '--'
        const statValues = document.querySelectorAll('.stat-value');
        statValues.forEach(stat => {
            stat.textContent = '--';
        });
    }

    async function detectImage() {
        if (!selectedFile || !document.getElementById('modelSelect').value) {
            showMessage('Please select an image and model weight', 'error');
            return;
        }

        // Reset all stat-values at the start
        resetAllStatValues();

        const detectBtn = document.getElementById('detectBtn');
        const loading = document.getElementById('loading');
        const detectionResultsContainer = document.getElementById('detectionResultsContainer');

        detectBtn.disabled = true;
        loading.style.display = 'block';
        detectionResultsContainer.style.display = 'block';
        hideMessages();

        try {
            // First, update the result image with current image from image-preview-wrapper
            const imageCanvas = document.getElementById('imagePreview');
            const resultImage = document.getElementById('resultImage');
            
            // Prepare source canvas: crop if active, else use full canvas
            let sourceCanvas = imageCanvas;
            let currentImageData;
            if (isCropActive()) {
                const tmp = document.createElement('canvas');
                tmp.width = Math.max(1, Math.floor(cropRect.w));
                tmp.height = Math.max(1, Math.floor(cropRect.h));
                const tctx = tmp.getContext('2d');
                tctx.imageSmoothingEnabled = true;
                tctx.imageSmoothingQuality = 'high';
                // Draw selected region from imagePreview onto tmp at 1:1
                tctx.drawImage(
                    imageCanvas,
                    Math.floor(cropRect.x), Math.floor(cropRect.y), Math.floor(cropRect.w), Math.floor(cropRect.h),
                    0, 0, Math.floor(cropRect.w), Math.floor(cropRect.h)
                );
                sourceCanvas = tmp;
                currentImageData = tmp.toDataURL('image/jpeg', 0.9);
            } else {
                currentImageData = imageCanvas.toDataURL('image/jpeg', 0.9);
            }
            
            // Update the result image to show what will be analyzed
            resultImage.src = currentImageData;
            resultImage.style.display = 'block';
            
            console.log('DEBUG: Updated resultImage with current canvas image');
            
            // Convert data URL to blob for FormData
            const imageResponse = await fetch(currentImageData);
            const blob = await imageResponse.blob();
            
            const formData = new FormData();
            formData.append('file', blob, 'current_image.jpg');
            formData.append('weight_path', document.getElementById('modelSelect').value);
            // No crop/transform parameters needed since we're sending the already processed canvas image
            formData.append('crop_x', 0);
            formData.append('crop_y', 0);
            formData.append('crop_w', sourceCanvas.width);
            formData.append('crop_h', sourceCanvas.height);
            formData.append('rotation', 0);
            formData.append('flip_horizontal', false);
            formData.append('flip_vertical', false);

            const response = await fetch('/api/detect_dinov3', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            
            if (data.success) {
                displayResults(data);
            } else {
                showMessage(data.error || 'Detection failed', 'error');
            }
        } catch (error) {
            console.error('Detection error:', error);
            showMessage('Detection failed: ' + error.message, 'error');
        } finally {
            detectBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function displayResults(data) {
        // Update all stat-values from API response
        if (data.inference_time !== undefined) {
            document.getElementById('inferenceTime').textContent = `${data.inference_time.toFixed(1)}ms`;
        }
        if (data.architecture !== undefined) {
            document.getElementById('architecture').textContent = data.architecture;
        }
        if (data.model_size !== undefined) {
            document.getElementById('modelSize').textContent = data.model_size;
        }
        if (data.input_size !== undefined) {
            document.getElementById('inputSize').textContent = data.input_size;
        }
        if (data.batch_size !== undefined) {
            document.getElementById('batchSize').textContent = data.batch_size;
        }
        if (data.used_weight_path !== undefined) {
            const el = document.getElementById('usedWeightPath');
            if (el) {
                // Extract only the filename from the full path
                const filename = data.used_weight_path.split('/').pop() || data.used_weight_path;
                el.textContent = filename;
            }
        }
        if (data.inferred_num_classes !== undefined) {
            const el = document.getElementById('inferredNumClasses');
            if (el) el.textContent = data.inferred_num_classes;
        }
        if (Array.isArray(data.class_names)) {
            const el = document.getElementById('classNames');
            if (el) {
                const shown = data.class_names.slice(0, 12).join(', ');
                const suffix = data.class_names.length > 12 ? `, +${data.class_names.length - 12} more` : '';
                el.textContent = shown + suffix;
            }
        }
        if (data.used_weight_path !== undefined) {
            // Extract only the filename from the full path
            const filename = data.used_weight_path.split('/').pop() || data.used_weight_path;
            document.getElementById('usedWeightPath').textContent = filename;
        }
        if (data.inferred_num_classes !== undefined) {
            document.getElementById('inferredNumClasses').textContent = data.inferred_num_classes;
        }
        if (Array.isArray(data.class_names)) {
            // show up to first 12 to avoid overflow
            const shown = data.class_names.slice(0, 12).join(', ');
            const suffix = data.class_names.length > 12 ? `, +${data.class_names.length - 12} more` : '';
            document.getElementById('classNames').textContent = shown + suffix;
        }
        // Update DINOv3 architecture details (with defaults if not provided)
        const backboneEl = document.getElementById('backbone');
        if (backboneEl) backboneEl.textContent = data.backbone || 'Vision Transformer';
        
        const attentionHeadsEl = document.getElementById('attentionHeads');
        if (attentionHeadsEl) attentionHeadsEl.textContent = data.attention_heads || '12';
        
        const layersEl = document.getElementById('layers');
        if (layersEl) layersEl.textContent = data.layers || '12';
        
        const embeddingDimEl = document.getElementById('embeddingDim');
        if (embeddingDimEl) embeddingDimEl.textContent = data.embedding_dim || '768';

        const resultImage = document.getElementById('resultImage');
        resultImage.src = data.image;
        
        resultImage.onload = function() {
            console.log('Result image loaded successfully');
            console.log('Detection result image:', {
                hasCrop: isCropActive(),
                imageSrc: data.image.substring(0, 50) + '...',
                shouldShowCrop: isCropActive() ? 'Only cropped patch' : 'Full image'
            });
        };
        
        resultImage.onerror = function() {
            console.error('Failed to load result image');
        };

        const predictionResult = document.getElementById('predictionResult');
        const predictionClass = document.getElementById('predictionClass');
        const predictionConfidence = document.getElementById('predictionConfidence');

        predictionClass.textContent = data.predicted_class;
        predictionConfidence.textContent = `Confidence: ${(data.confidence * 100).toFixed(1)}%`;
        predictionResult.style.display = 'block';

        if (data.top3_predictions && data.top3_predictions.length >= 3) {
            const prediction1 = document.getElementById('prediction1');
            const prediction2 = document.getElementById('prediction2');
            const prediction3 = document.getElementById('prediction3');
            
            prediction1.textContent = `1. ${data.top3_predictions[0].class}: ${data.top3_predictions[0].probability.toFixed(4)}`;
            prediction2.textContent = `2. ${data.top3_predictions[1].class}: ${data.top3_predictions[1].probability.toFixed(4)}`;
            prediction3.textContent = `3. ${data.top3_predictions[2].class}: ${data.top3_predictions[2].probability.toFixed(4)}`;
        }
    }

    function isCropActive() {
        return cropRect.w > 5 && cropRect.h > 5;
    }

    function updateCropOverlayPosition() {
        const canvas = document.getElementById('imagePreview');
        const overlay = document.getElementById('cropOverlay');
        if (!canvas || !overlay) return;
        if (!isCropActive() && !isCropping) {
            overlay.style.display = 'none';
            return;
        }
        overlay.style.display = 'block';
        // Position overlay relative to canvas element
        overlay.style.left = `${Math.min(cropRect.x, cropRect.x + cropRect.w)}px`;
        overlay.style.top = `${Math.min(cropRect.y, cropRect.y + cropRect.h)}px`;
        overlay.style.width = `${Math.abs(cropRect.w)}px`;
        overlay.style.height = `${Math.abs(cropRect.h)}px`;
    }

    function normalizeCropRect() {
        // Ensure positive width/height and normalize origin
        if (cropRect.w < 0) {
            cropRect.x = cropRect.x + cropRect.w;
            cropRect.w = Math.abs(cropRect.w);
        }
        if (cropRect.h < 0) {
            cropRect.y = cropRect.y + cropRect.h;
            cropRect.h = Math.abs(cropRect.h);
        }
        // Clamp within canvas bounds
        const canvas = document.getElementById('imagePreview');
        cropRect.x = Math.max(0, Math.min(cropRect.x, canvas.width - 1));
        cropRect.y = Math.max(0, Math.min(cropRect.y, canvas.height - 1));
        cropRect.w = Math.max(0, Math.min(cropRect.w, canvas.width - cropRect.x));
        cropRect.h = Math.max(0, Math.min(cropRect.h, canvas.height - cropRect.y));
    }

    function clearCrop() {
        cropRect = { x: 0, y: 0, w: 0, h: 0 };
        const overlay = document.getElementById('cropOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    function showMessage(message, type) {
        hideMessages();
        const messageDiv = document.getElementById(type === 'error' ? 'errorMessage' : 'successMessage');
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    function hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }

    // Add event listener for detect button
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('detectBtn').addEventListener('click', detectImage);
    });
</script>
{% endblock %}
